---
to: libs/<%=contextFileName%>/<%=timeLineFileName%>/src/lib/<%=queryFileName%>/<%=timeLineFileName%>-<%=queryFileName%>.query.ts
force: true
---
import {
  eventHandler,
  query,
  Query,
  QueryDatabaseModel,
  queryHandler,
} from '@ebd-connect/cqrs-framework';

export interface I<%=ContextName%>.<%=TimeLineName%>.<%=QueryName%> {
<%queries[queryIndex].facts.map( (fact) => {%>  <%=h.changeCase.camel(fact.name)%>: <%=fact.dataType%>;
<%})-%>
}

@query('<%=ContextName%>.<%=TimeLineName%>.<%=QueryName%>')
export class <%=ContextName%>.<%=TimeLineName%>.<%=QueryName%> implements Query {
  $responseType!: I<%=ContextName%>.<%=TimeLineName%>.<%=QueryName%> | null
  constructor(
<%queries[queryIndex].facts.map( (fact) => {%>  public readonly <%=h.changeCase.camel(fact.name)%>: <%=fact.dataType%>,
<%})-%>
) {}
}

export const <%=timeLineName%><%=QueryName%>QueryDb
  = new QueryDatabaseModel< I<%=ContextName%>.<%=TimeLineName%>.<%=QueryName%> >('<%=timeLineFileName%>-<%=queryFileName%>')

export class <%=ContextName%>.<%=TimeLineName%>.<%=QueryName%>QueryHandler {
@queryHandler({ name:'<%=ContextName%>.<%=TimeLineName%>.<%=QueryName%>'})
  async <%=timeLineName%><%=QueryName%>(){
    return <%=timeLineName%><%=QueryName%>QueryDb.findAll()
  }
}

export class <%=ContextName%>.<%=TimeLineName%>.<%=QueryName%>QueryProjector {
<%queries[queryIndex].events.map((item) => {-%>
  @eventHandler({name:'<%=TimeLineName%><%=h.changeCase.pascalCase(item.name)%>'})
  async on<%=TimeLineName%><%=h.changeCase.pascalCase(item.name)%>({<%=identifierName%>: id,...data}: <%=TimeLineName%><%=h.changeCase.pascalCase(item.name)%>) {
    await <%=timeLineName%><%=QueryName%>QueryDb.patch(id, {<%=identifierName%>: id, ...data})
<%})-%>}
}
